name: Release & Publish

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.2.3). If not provided, uses package.json version.'
        required: true
        type: string

permissions:
  contents: write
  id-token: write # REQUIRED for OIDC

jobs:
  release:
    name: ğŸš€ Build & Release
    runs-on: ubuntu-latest
    environment: npm-publish

    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "yarn"

      # 1. Bump Version
      - name: ğŸ†” Set Version
        id: package
        run: |
          npm version ${{ inputs.version }} --no-git-tag-version
          echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT

      # 2. Build
      - name: ğŸ› ï¸ Install & Build
        run: |
          yarn install --frozen-lockfile
          yarn build

      # 3. Check for Dirty Git Status (Debugging)
      - name: ğŸ•µï¸ Check Git Status
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "::warning::âš ï¸ Git tree is dirty! Attempting to ignore scripts to bypass."
            git status
          else
            echo "âœ… Git tree is clean."
          fi

      # 4. Publish to NPM
      # --ignore-scripts: Stops Husky from dirtying the tree
      # --provenance: Enables OIDC
      - name: ğŸš€ Publish to NPM
        run: npm publish --provenance --access public --ignore-scripts --registry https://registry.npmjs.org/

      # 5. Create Release
      - name: ğŸ·ï¸ Create GitHub Release
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
        run: |
          gh release create "v$VERSION" --title "v$VERSION" --generate-notes --target "main"