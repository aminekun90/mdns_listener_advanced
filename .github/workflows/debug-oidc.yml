name: Debug OIDC

on: [workflow_dispatch]

permissions:
  id-token: write
  contents: read

jobs:
  debug-claims:
    runs-on: ubuntu-latest
    environment: npm-publish # We test with the environment to match your goal
    steps:
      - name: Install OIDC Client
        run: npm install -g @actions/core @actions/http-client

      - name: Debug OIDC Claims
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            try {
              // Request the ID token
              const token = await core.getIDToken('npm');
              
              // Decode it (it's just base64) to show the claims
              const payload = token.split('.')[1];
              const claims = JSON.parse(Buffer.from(payload, 'base64').toString());
              
              console.log("---------------------------------------------------");
              console.log("✅ YOUR EXACT OIDC SUBJECT IS:");
              console.log(claims.sub);
              console.log("---------------------------------------------------");
              console.log("ℹ️  Repository Claim: " + claims.repository);
              console.log("ℹ️  Workflow Claim:   " + claims.job_workflow_ref);
              console.log("---------------------------------------------------");
            } catch (err) {
              core.setFailed(err.message);
            }