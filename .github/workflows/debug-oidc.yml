name: Debug OIDC

on: [workflow_dispatch]

permissions:
  id-token: write
  contents: read

jobs:
  debug-claims:
    runs-on: ubuntu-latest
    environment: npm-publish # Matches your intended environment
    steps:
      - name: Debug OIDC Claims
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // 'core' is already available globally in this action
              const token = await core.getIDToken('npm');
              
              const payload = token.split('.')[1];
              const claims = JSON.parse(Buffer.from(payload, 'base64').toString());
              
              console.log("---------------------------------------------------");
              console.log("✅ YOUR EXACT OIDC SUBJECT IS:");
              console.log(claims.sub);
              console.log("---------------------------------------------------");
              console.log("ℹ️  Repository Claim: " + claims.repository);
              console.log("ℹ️  Workflow Claim:   " + claims.job_workflow_ref);
              console.log("---------------------------------------------------");
            } catch (err) {
              core.setFailed(err.message);
            }